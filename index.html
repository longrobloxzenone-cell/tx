<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TÃ i Xá»‰u Firebase</title>

<style>
body{background:#111;color:#fff;font-family:Arial;text-align:center}
.hidden{display:none}
.dice{font-size:40px;margin:10px}
button,input{margin:5px;padding:6px}
#adminPanel{border:1px solid #555;padding:10px;margin-top:15px}
</style>
</head>
<body>

<h2>ğŸ² TÃ€I Xá»ˆU</h2>

<!-- AUTH -->
<div id="authBox">
  <input id="email" placeholder="Email"><br>
  <input id="password" type="password" placeholder="Máº­t kháº©u"><br>
  <button onclick="login()">ÄÄƒng nháº­p</button>
  <button onclick="register()">ÄÄƒng kÃ½</button>
</div>

<!-- GAME -->
<div id="gameBox" class="hidden">
  <p>Xin chÃ o: <span id="userEmail"></span></p>
  <p>VÃ­: <span id="money">0</span> $</p>
  <button onclick="logout()">ÄÄƒng xuáº¥t</button>

  <div class="dice" id="dice">ğŸ² ğŸ² ğŸ²</div>

  <p>CÆ°á»£c: <span id="bet">100</span> | Chá»n: <span id="choice">-</span></p>
  <button onclick="setChoice('TÃ i')">TÃ i</button>
  <button onclick="setChoice('Xá»‰u')">Xá»‰u</button><br>
  <button onclick="roll()">Quay</button>

  <!-- ADMIN -->
  <div id="adminPanel" class="hidden">
    <h3>ADMIN PANEL</h3>

    ğŸ¯ Tá»‰ lá»‡ tháº¯ng:
    <input id="winRateInput" type="number" step="0.01">
    <button onclick="updateWinRate()">Cáº­p nháº­t</button><br>

    âš  Ã‰p káº¿t quáº£:
    <button onclick="forceResult('TÃ i')">Ã‰p TÃ i</button>
    <button onclick="forceResult('Xá»‰u')">Ã‰p Xá»‰u</button>
    <button onclick="forceResult(null)">Huá»· Ã©p</button><br>

    â›” KhoÃ¡ cÆ°á»£c:
    <button onclick="toggleLock()">Báº­t / Táº¯t</button><br>

    ğŸ’¸ Cá»™ng tiá»n user:
    <input id="targetUid" placeholder="UID user">
    <input id="amount" type="number" placeholder="Sá»‘ tiá»n">
    <button onclick="addMoney()">Cá»™ng</button>
    <button onclick="subMoney()">Trá»«</button>

    <p id="adminStatus"></p>
  </div>
</div>

<!-- FIREBASE v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyAyUe1QL_olzsDOSd2-hNlI-Y-mjPG8WpQ",
  authDomain: "tx78-78.firebaseapp.com",
  projectId: "tx78-78"
});

const auth = firebase.auth();
const db = firebase.firestore();

const diceDiv = document.getElementById("dice");

let currentUser, choice=null, bet=100;
let winRate=0.5, force=null, locked=false;

/* AUTH */
function register(){auth.createUserWithEmailAndPassword(email.value,password.value);}
function login(){auth.signInWithEmailAndPassword(email.value,password.value);}
function logout(){auth.signOut();}

/* AUTH STATE */
auth.onAuthStateChanged(u=>{
  if(!u){
    authBox.classList.remove("hidden");
    gameBox.classList.add("hidden");
    return;
  }
  currentUser=u;
  userEmail.innerText=u.email;
  authBox.classList.add("hidden");
  gameBox.classList.remove("hidden");

  const ref=db.collection("users").doc(u.uid);
  ref.get().then(d=>{
    if(!d.exists) ref.set({money:1000,isAdmin:false});
  });

  ref.onSnapshot(d=>{
    money.innerText=d.data().money;
    adminPanel.classList.toggle("hidden",!d.data().isAdmin);
  });
});

/* CONFIG */
db.collection("config").doc("game").onSnapshot(d=>{
  if(d.exists){
    winRate=d.data().winRate;
    force=d.data().force||null;
    locked=d.data().locked||false;
    winRateInput.value=winRate;
  }
});

/* GAME */
function setChoice(c){choice=c;document.getElementById("choice").innerText=c;}

function roll(){
  if(locked) return alert("Äang khoÃ¡ cÆ°á»£c");
  if(!choice) return alert("Chá»n TÃ i/Xá»‰u");

  let dice=[1,1,1].map(()=>Math.floor(Math.random()*6)+1);
  diceDiv.innerText=dice.join(" ");
  let sum=dice.reduce((a,b)=>a+b,0);
  let result=sum>=11?"TÃ i":"Xá»‰u";

  if(force) result=force;
  else if(Math.random()>winRate) result=choice==="TÃ i"?"Xá»‰u":"TÃ i";

  const win=result===choice;

  db.collection("users").doc(currentUser.uid).update({
    money: firebase.firestore.FieldValue.increment(win?bet:-bet)
  });

  db.collection("logs").add({
    uid:currentUser.uid,
    result, dice, time:Date.now()
  });

  alert(win?"THáº®NG":"THUA");
}

/* ADMIN */
function updateWinRate(){
  db.collection("config").doc("game").set({
    winRate, force, locked
  });
}

function forceResult(r){
  db.collection("config").doc("game").update({force:r});
}

function toggleLock(){
  db.collection("config").doc("game").update({locked:!locked});
}

function addMoney(){
  db.collection("users").doc(targetUid.value)
  .update({money:firebase.firestore.FieldValue.increment(+amount.value)});
}
function subMoney(){
  db.collection("users").doc(targetUid.value)
  .update({money:firebase.firestore.FieldValue.increment(-amount.value)});
}
</script>
</body>
</html>
