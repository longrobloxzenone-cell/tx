<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TÃ i Xá»‰u Firebase</title>

<style>
body{
  background: linear-gradient(to bottom,#8b0000,#000);
  color:#fff;
  font-family:Arial, sans-serif;
  text-align:center;
  margin:0;
}
input,button{
  padding:8px;
  margin:5px;
  border-radius:5px;
  border:none;
}
button{cursor:pointer}
#diceArea{display:flex;justify-content:center;gap:10px;margin:20px}
.dice{
  width:80px;height:80px;
  background:#fff;color:#000;
  font-size:40px;
  display:flex;align-items:center;justify-content:center;
  border-radius:10px;
}
.chip{
  display:inline-block;
  width:60px;height:60px;
  border-radius:50%;
  line-height:60px;
  background:#2196f3;
  margin:5px;
  cursor:pointer;
}
.chip.selected{outline:3px solid gold}
#adminPanel{display:none;border-top:1px solid #fff;margin-top:10px}
#chatMessages{
  height:150px;
  overflow:auto;
  background:#222;
  padding:5px;
}
</style>
</head>

<body>

<h2>TÃ€I Xá»ˆU FIREBASE</h2>

<!-- LOGIN -->
<div id="loginPanel">
  <input id="username" placeholder="TÃªn Ä‘Äƒng nháº­p">
  <input id="password" type="password" placeholder="Máº­t kháº©u"><br>
  <button onclick="register()">ÄÄƒng kÃ½</button>
  <button onclick="login()">ÄÄƒng nháº­p</button>
</div>

<!-- GAME -->
<div id="gamePanel" style="display:none">
  <h3>Xin chÃ o <span id="userName"></span></h3>
  <button onclick="logout()">ÄÄƒng xuáº¥t</button>
  <div>VÃ­: <span id="money">0</span> $</div>

  <div id="diceArea">
    <div class="dice" id="dice1">ğŸ²</div>
    <div class="dice" id="dice2">ğŸ²</div>
    <div class="dice" id="dice3">ğŸ²</div>
  </div>

  <div>
    <div class="chip" data-value="1000">1K</div>
    <div class="chip" data-value="5000">5K</div>
    <div class="chip" data-value="10000">10K</div>
  </div>

  <div id="selectedBet">CÆ°á»£c: 0 | -</div>
  <button onclick="chooseBet('TÃ i')">TÃ i</button>
  <button onclick="chooseBet('Xá»‰u')">Xá»‰u</button>
  <button onclick="rollDice()">Quay</button>

  <div id="result"></div>

  <!-- CHAT -->
  <div>
    <div id="chatMessages"></div>
    <input id="chatInput">
    <button onclick="sendChat()">Gá»­i</button>
  </div>

  <!-- ADMIN -->
  <div id="adminPanel">
    <h4>ADMIN</h4>
    <button onclick="force('TÃ i')">Ã‰p TÃ i</button>
    <button onclick="force('Xá»‰u')">Ã‰p Xá»‰u</button>
    <button onclick="force(null)">Huá»· Ã©p</button>
    <button onclick="toggleLock()">KhoÃ¡ cÆ°á»£c</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

/* ğŸ”¥ FIREBASE Cá»¦A Báº N */
const firebaseConfig = {
  apiKey: "AIzaSyA2iT-gWTUeRQUOx7wRa7hhsMc6cnDtess",
  authDomain: "txtest2.firebaseapp.com",
  projectId: "txtest2",
  storageBucket: "txtest2.firebasestorage.app",
  messagingSenderId: "917472071434",
  appId: "1:917472071434:web:aaf32077b464fbc5e8b4f3"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser=null, bet=0, choice=null, locked=false, forceResult=null;

/* ===== FIX QUAN TRá»ŒNG: Gáº®N WINDOW ===== */
window.register = async ()=>{
  const u=username.value,p=password.value;
  const email=u+"@game.com";
  await createUserWithEmailAndPassword(auth,email,p);
  await setDoc(doc(db,"users",u),{money:500000,isAdmin:false});
  alert("ÄÄƒng kÃ½ OK");
}

window.login = async ()=>{
  const u=username.value,p=password.value;
  const email=u+"@game.com";
  await signInWithEmailAndPassword(auth,email,p);
  currentUser=u;
  userName.innerText=u;
  loginPanel.style.display="none";
  gamePanel.style.display="block";
  loadUser();
  listenAdmin();
  listenChat();
}

window.logout = ()=>{
  signOut(auth);
  location.reload();
}

document.querySelectorAll(".chip").forEach(c=>{
  c.onclick=()=>{
    bet=+c.dataset.value;
    document.querySelectorAll(".chip").forEach(x=>x.classList.remove("selected"));
    c.classList.add("selected");
    updateBet();
  }
});

window.chooseBet = c=>{
  choice=c;
  updateBet();
}

function updateBet(){
  selectedBet.innerText=`CÆ°á»£c: ${bet} | ${choice||"-"}`;
}

async function loadUser(){
  const s=await getDoc(doc(db,"users",currentUser));
  money.innerText=s.data().money;
  if(s.data().isAdmin) adminPanel.style.display="block";
}

window.rollDice = async ()=>{
  if(locked) return alert("Äang khoÃ¡ cÆ°á»£c");
  if(!bet||!choice) return alert("ChÆ°a chá»n cÆ°á»£c");
  const ref=doc(db,"users",currentUser);
  const s=await getDoc(ref);
  let m=s.data().money;
  if(m<bet) return alert("KhÃ´ng Ä‘á»§ tiá»n");

  let d=[1,2,3].map(()=>Math.floor(Math.random()*6)+1);
  dice1.innerText=d[0];dice2.innerText=d[1];dice3.innerText=d[2];
  let sum=d[0]+d[1]+d[2];
  let rs=sum>=11?"TÃ i":"Xá»‰u";
  if(forceResult) rs=forceResult;
  let win=rs===choice;
  let newMoney=win?m+bet:m-bet;

  await updateDoc(ref,{money:newMoney});
  money.innerText=newMoney;
  result.innerText=`${rs} (${sum})`;
}

async function initAdmin(){
  const r=doc(db,"config","admin");
  if(!(await getDoc(r)).exists()) await setDoc(r,{locked:false,force:null});
}

function listenAdmin(){
  initAdmin();
  onSnapshot(doc(db,"config","admin"),s=>{
    locked=s.data().locked;
    forceResult=s.data().force;
  });
}

window.force=async v=>{
  await updateDoc(doc(db,"config","admin"),{force:v});
}
window.toggleLock=async ()=>{
  locked=!locked;
  await updateDoc(doc(db,"config","admin"),{locked});
}

/* CHAT */
window.sendChat=async ()=>{
  if(!chatInput.value) return;
  await addDoc(collection(db,"chat"),{
    user:currentUser,
    msg:chatInput.value,
    time:Date.now()
  });
  chatInput.value="";
}

function listenChat(){
  const q=query(collection(db,"chat"),orderBy("time"));
  onSnapshot(q,s=>{
    chatMessages.innerHTML="";
    s.forEach(d=>{
      chatMessages.innerHTML+=`<b>${d.data().user}:</b> ${d.data().msg}<br>`;
    });
    chatMessages.scrollTop=9999;
  });
}
</script>
</body>
</html>
