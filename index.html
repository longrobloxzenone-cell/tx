<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>T√†i X·ªâu Casino v9 + Chat</title>
<style>
body { margin:0; padding:0; background: radial-gradient(circle,#0f0c29,#302b63,#24243e); font-family:Arial; color:white; text-align:center; }
h2 { color:#ffd700; text-shadow:0 0 8px #fff; }
#gameBox, #adminPanel, #playersBox, #chatBox { background: rgba(0,0,0,0.7); width:380px; margin:20px auto; padding:20px; border-radius:20px; box-shadow:0 0 25px #ff00ff; transition:0.3s; }
.dice { font-size:50px; margin:15px; display:flex; justify-content:center; gap:10px; }
.dice span { width:60px; height:60px; line-height:60px; display:inline-block; background: rgba(255,255,255,0.1); border-radius:10px; box-shadow:0 0 10px #fff; transition:0.2s; }
.winEffect { animation: glow 0.8s infinite alternate; }
.loseEffect { animation: shake 0.5s; }
@keyframes shake { 0%{transform:translateX(0)} 25%{transform:translateX(-8px)} 50%{transform:translateX(8px)} 75%{transform:translateX(-8px)} 100%{transform:translateX(0)} }
@keyframes glow { from{box-shadow:0 0 15px #00ff00} to{box-shadow:0 0 35px #00ff00} }
button { margin:5px; padding:8px; border-radius:10px; border:none; font-size:16px; cursor:pointer; box-shadow:0 0 5px #fff; transition:0.2s; }
button:hover { transform:scale(1.05); box-shadow:0 0 15px #fff; }
.playerCard { background: rgba(255,255,255,0.1); margin:8px 0; padding:10px; border-radius:10px; box-shadow:0 0 10px #fff; text-align:left; transition:0.3s; }
.playerCard:hover { background: rgba(255,255,255,0.2); box-shadow:0 0 20px #fff; }
.playerCard .money { color:#00ff00; font-weight:bold; }
.playerCard .bet { color:#ffd700; font-weight:bold; }
.playerCard .role { color:#ff69b4; font-weight:bold; }
#notification { position:fixed;top:10px;left:50%;transform:translateX(-50%);background:#ff0;color:#000;padding:10px 20px;border-radius:10px;display:none;box-shadow:0 0 15px #fff;z-index:999; font-weight:bold;}
#chatBox input { padding:5px; border-radius:5px; border:none; }
</style>
</head>
<body>

<h2>üé≤ T√ÄI X·ªàU CASINO v9 + Chat</h2>

<!-- Notification -->
<div id="notification">Th√¥ng b√°o</div>

<!-- Auth -->
<div id="authBox">
  <input id="email" placeholder="Email"><br>
  <input id="password" type="password" placeholder="M·∫≠t kh·∫©u"><br>
  <button onclick="login()">ƒêƒÉng nh·∫≠p</button>
  <button onclick="register()">ƒêƒÉng k√Ω</button>
</div>

<!-- Game Box -->
<div id="gameBox" style="display:none;">
  <p>Xin ch√†o: <span id="userEmail"></span></p>
  <p>V√≠: <span id="money">0</span> $</p>
  <button onclick="logout()">ƒêƒÉng xu·∫•t</button>

  <div class="dice" id="dice">
    <span>üé≤</span><span>üé≤</span><span>üé≤</span>
  </div>

  <p>C∆∞·ª£c: <input type="number" id="betInput" value="100" style="width:70px;"> | Ch·ªçn: <span id="choice">-</span></p>
  <button onclick="setChoice('T√†i')">T√†i</button>
  <button onclick="setChoice('X·ªâu')">X·ªâu</button><br>
  <button onclick="roll()">Quay</button>

  <!-- Player list -->
  <div id="playersBox">
    <h3>üéÆ Ng∆∞·ªùi ch∆°i</h3>
    <div id="playerList"></div>
  </div>

  <!-- Chat Box -->
  <div id="chatBox">
    <h3>üí¨ Chat t·ªïng</h3>
    <div id="chatMessages" style="height:150px;overflow-y:auto;border:1px solid #fff;padding:5px;margin-bottom:5px;"></div>
    <input id="chatInput" placeholder="Nh·∫≠p tin nh·∫Øn..." style="width:75%">
    <button onclick="sendChat()">G·ª≠i</button>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" style="display:none;">
    <h3>üíº ADMIN PANEL</h3>
    ‚ö† **√âp k·∫øt qu·∫£:** 
    <button onclick="forceResult('T√†i')">√âp T√†i</button>
    <button onclick="forceResult('X·ªâu')">√âp X·ªâu</button>
    <button onclick="forceResult(null)">Hu·ª∑ √©p</button><br>
    ‚õî **Kho√° c∆∞·ª£c:** <button onclick="toggleLock()">B·∫≠t / T·∫Øt</button><br>
    üí∏ **Qu·∫£n l√Ω ti·ªÅn user:**<br>
    UID user: <input id="targetUid" placeholder="UID user">
    S·ªë ti·ªÅn: <input id="amount" type="number" placeholder="S·ªë ti·ªÅn">
    <button onclick="addMoney()">C·ªông ti·ªÅn</button>
    <button onclick="subMoney()">Tr·ª´ ti·ªÅn</button>
    <p id="adminStatus"></p>
  </div>

  <p id="resultDiv" style="font-size:20px;margin-top:10px;"></p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, increment, collection, addDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAyUe1QL_olzsDOSd2-hNlI-Y-mjPG8WpQ",
  authDomain: "tx78-78.firebaseapp.com",
  projectId: "tx78-78",
  storageBucket: "tx78-78.firebasestorage.app",
  messagingSenderId: "166220100814",
  appId: "1:166220100814:web:928271b561494aa3190c9f",
  measurementId: "G-LQDTCNZ2W5"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// DOM elements
const email = document.getElementById("email");
const password = document.getElementById("password");
const moneyEl = document.getElementById("money");
const userEmail = document.getElementById("userEmail");
const diceDiv = document.getElementById("dice");
const diceSpans = diceDiv.querySelectorAll("span");
const resultDiv = document.getElementById("resultDiv");
const adminStatus = document.getElementById("adminStatus");
const targetUid = document.getElementById("targetUid");
const amount = document.getElementById("amount");
const notification = document.getElementById("notification");
const chatMessages = document.getElementById("chatMessages");
const chatInput = document.getElementById("chatInput");

let currentUser, choice=null, force=null, locked=false;

// -------- AUTH --------
async function register(){
  const userCred = await createUserWithEmailAndPassword(auth,email.value,password.value);
  await setDoc(doc(db,"users",userCred.user.uid),{email:userCred.user.email,money:1000,bet:0,isAdmin:false});
}
async function login(){ await signInWithEmailAndPassword(auth,email.value,password.value); }
function logout(){ signOut(auth); }

onAuthStateChanged(auth,async user=>{
  if(!user){ authBox.style.display="block"; gameBox.style.display="none"; return; }
  currentUser = user;
  userEmail.innerText = user.email;
  authBox.style.display="none"; gameBox.style.display="block";

  const userRef = doc(db,"users",user.uid);
  const docSnap = await getDoc(userRef);
  if(!docSnap.exists()) await setDoc(userRef,{email:user.email,money:1000,bet:0,isAdmin:false});

  onSnapshot(userRef,d=>{
    const userData = d.data();
    moneyEl.innerText=userData.money;
    adminPanel.style.display = userData.isAdmin?"block":"none"; // Ch·ªâ admin th·∫•y
  });
});

// -------- GAME --------
function setChoice(c){ choice=c; document.getElementById("choice").innerText=c; }

async function roll(){
  if(locked) { showNotification("‚ö† C∆∞·ª£c ƒëang b·ªã kh√≥a!"); return; }
  const betVal = Number(document.getElementById("betInput").value);
  if(!choice || betVal<=0) return alert("Ch·ªçn T√†i/X·ªâu v√† nh·∫≠p c∆∞·ª£c");

  diceSpans.forEach(s=>s.innerText="üé≤");
  setTimeout(async ()=>{
    const dice=[1,1,1].map(()=>Math.floor(Math.random()*6)+1);
    diceSpans.forEach((s,i)=>s.innerText=["‚öÄ","‚öÅ","‚öÇ","‚öÉ","‚öÑ","‚öÖ"][dice[i]-1]);
    let sum=dice.reduce((a,b)=>a+b,0);
    let result=sum>=11?"T√†i":"X·ªâu";
    if(force) result=force; else if(Math.random()<0.2) result = choice==="T√†i"?"X·ªâu":"T√†i";
    const win = result===choice;
    await updateDoc(doc(db,"users",currentUser.uid),{money:increment(win?betVal:-betVal), bet:betVal});

    diceDiv.classList.remove("winEffect","loseEffect"); void diceDiv.offsetWidth;
    diceDiv.classList.add(win?"winEffect":"loseEffect");
    resultDiv.innerHTML = `${win?"üî• TH·∫ÆNG":"üíÄ THUA"} | T·ªïng: ${sum}`;

    await addDoc(collection(db,"logs"),{uid:currentUser.uid,dice,diceSum:sum,choice,result,win,time:Date.now()});
  },500);
}

// -------- PLAYER LIST --------
function updatePlayerCard(uid,email,money,bet,isAdmin){
  let card=document.getElementById("user-"+uid);
  if(!card){
    card=document.createElement("div"); card.className="playerCard"; card.id="user-"+uid;
    card.innerHTML=`<p>Email: ${email}</p><p>Ti·ªÅn: <span class="money">${money}</span>$</p><p>M·ª©c c∆∞·ª£c: <span class="bet">${bet}</span>$</p><p>Tr·∫°ng th√°i: <span class="role">${isAdmin?"Admin":"User"}</span></p>`;
    document.getElementById("playerList").appendChild(card);
  } else {
    card.querySelector(".money").innerText=money;
    card.querySelector(".bet").innerText=bet;
    card.querySelector(".role").innerText=isAdmin?"Admin":"User";
  }
}
onSnapshot(collection(db,"users"), snapshot=>{ snapshot.docs.forEach(doc=>{ const d=doc.data(); updatePlayerCard(doc.id,d.email,d.money,d.bet||0,d.isAdmin); }); });

// -------- ADMIN --------
const configRef = doc(db,"config","game");
setDoc(configRef,{force:null,locked:false},{merge:true});

onSnapshot(configRef,d=>{
  if(d.exists){
    const prevLocked = locked;
    force = d.data().force || null;
    locked = d.data().locked || false;
    if(prevLocked !== null && prevLocked !== locked){
      showNotification(locked ? "‚ö† C∆∞·ª£c ƒë√£ b·ªã kh√≥a b·ªüi Admin" : "‚úÖ C∆∞·ª£c ƒë√£ m·ªü tr·ªü l·∫°i");
    }
  }
});

function showNotification(msg){ notification.innerText=msg; notification.style.display="block"; setTimeout(()=>{ notification.style.display="none"; },4000); }

async function forceResult(r){ await updateDoc(configRef,{force:r}); }
async function toggleLock(){ await updateDoc(configRef,{locked:!locked}); }
async function addMoney(){ const uid=targetUid.value,val=Number(amount.value); if(!uid||isNaN(val)) return alert("Nh·∫≠p UID v√† s·ªë ti·ªÅn"); await updateDoc(doc(db,"users",uid),{money:increment(val)}); adminStatus.innerText=`‚úÖ C·ªông ${val}$ cho ${uid}`; }
async function subMoney(){ const uid=targetUid.value,val=Number(amount.value); if(!uid||isNaN(val)) return alert("Nh·∫≠p UID v√† s·ªë ti·ªÅn"); await updateDoc(doc(db,"users",uid),{money:increment(-val)}); adminStatus.innerText=`‚úÖ Tr·ª´ ${val}$ c·ªßa ${uid}`; }

// -------- CHAT --------
async function sendChat(){
  const msg = chatInput.value.trim();
  if(!msg) return;
  await addDoc(collection(db,"chat"),{uid:currentUser.uid,email:currentUser.email,message:msg,time:Date.now()});
  chatInput.value="";
}

const chatQuery = query(collection(db,"chat"), orderBy("time"));
onSnapshot(chatQuery,snapshot=>{
  chatMessages.innerHTML = "";
  snapshot.docs.forEach(doc=>{
    const d = doc.data();
    const div = document.createElement("div");
    div.innerHTML = `<b>${d.email}:</b> ${d.message}`;
    chatMessages.appendChild(div);
  });
  chatMessages.scrollTop = chatMessages.scrollHeight;
});
</script>
</body>
</html>
